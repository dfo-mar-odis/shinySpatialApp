
```{r cetacean setup, echo=FALSE, include=FALSE, cache=FALSE}
whale_col=values=c("Beluga Whale: Endangered (SARA & COSEWIC)"="cyan3","Blue Whale: Endangered (SARA & COSEWIC)"="black", "Fin Whale: Special Concern (SARA & COSEWIC)"="chartreuse4", "Harbour Porpoise: Threatened (SARA) Special Concern (COSEWIC)"="red","Killer Whale: No Status (SARA) & Special Concern (COSEWIC)"="#00AFBB", "North Atlantic Right Whale: Endangered (SARA & COSEWIC)"="darkorchid4", "Northern Bottlenose Whale: Endangered (SARA & COSEWIC)"="#0827EF", "Sei Whale: No Status (SARA) & Endangered (COSEWIC)"="#EF6408",  "Sowerby's Beaked Whale: Special Concern (SARA & COSEWIC)"="#F5A4E7")
```

### **Whale Sightings Database (WSDB)**  

#### ***Area-specific WSDB search results***

```{r wsdb, include=FALSE, cache=FALSE}
outputList <- main_intersect(wsdb_sf, studyArea, Bbox = bboxMap)

if (!is.null(outputList)) {
wsdb_points <- sfcoords_as_cols(outputList[[2]])
}
```
*
```{r wsdb result, comment="", prompt=TRUE, echo=FALSE, results='asis'}
Report_wsdb <- if (is.null(outputList)) {
   "There are no relevant records in the WSDB for this search area."
 } else {
   "There are relevant records in the WSDB for this search area."
 }
 writeLines(Report_wsdb)
```

```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: Low. Security level: none. Map showing the search area defined by the user (red outline). Map displays information from the Whale Sightings Database (WSDB) (including sightings of groups of animals), for cetacean species in the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild Species listings. <b>The absence of a species in this map should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b> Absence may be related to low or no survey effort. Sightings information is known to underrepresent the presence of cetaceans, particularly deep diving species (e.g., beaked whales) that spend little time at the surface. This map also does not include acoustic detections. Sightings on land are an indicator that the sighting data have not yet been completely error-checked or that animals were sighted from shore.'}
if (!is.null(outputList)) {
  areaMap+ 
    geom_point(data = wsdb_points, aes(x = long, y = lat, color=Legend), size = 2, shape = 20) +
    ggplot2::scale_colour_manual(values=whale_col)
}
```

### **The Whitehead Lab, Dalhousie University**
#### ***Area-specific Whitehead Lab search results***

```{r whitehead, include=FALSE, cache=FALSE}
outputList <- main_intersect(whitehead_sf, studyArea, Bbox = bboxMap)
if (!is.null(outputList)) {
  whitehead_points <- sfcoords_as_cols(outputList[[2]])
}
```
*
```{r whitehead result, comment="", prompt=TRUE, echo=FALSE, results='asis'}
Report_whitehead <-  if (is.null(outputList)) {
   "There are no relevant records in the Whitehead Lab database for this search area."
 } else {
   "There are relevant records in the Whitehead Lab database for this search area."
 }
writeLines(Report_whitehead)
```

```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: High. Security level: none. Map showing the search area defined by the user (red outline). Map displays information from the Whitehead Lab, for cetacean species in the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listing. Field efforts were primarily conducted in the Gully Marine Protected Area, and adjacent canyons along the edge of the eastern Scotian Shelf, during good weather conditions (for example, see Whitehead 2013 for a map of effort between 1988-2011), though some data from surveys along the shelf edge off Nova Scotia, Newfoundland and Labrador are included. <b>The absence of a species in this map should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b> Absence may be related to low or no survey effort. This map also does not include acoustic detections. Sightings information is known to underrepresent the presence of cetaceans, particularly deep diving species (e.g., beaked whales) that spend little time at the surface. For more information, please visit: <https://whiteheadlab.weebly.com/contact.html>'}
if (!is.null(outputList)) {
  areaMap+ 
    geom_point(data = whitehead_points, aes(x = long, y = lat, color=Legend),
               size = 2, shape = 20)+ 
    ggplot2::scale_colour_manual(values=whale_col)
}
```

### **North Atlantic Right Whale Consortium (NARWC) Sightings Database**  

#### ***Area-specific NARWC search results***
```{r narwc, include=FALSE, cache=FALSE}
outputList <- main_intersect(narwc_sf, studyArea, Bbox = bboxMap)

if (!is.null(outputList)) {
  narwc_points <- sfcoords_as_cols(outputList[[2]])
}
```
*
```{r narwc result, comment="", prompt=TRUE, echo=FALSE, results='asis'}
Report_narwc <-  if (is.null(outputList)) {
   "There are no relevant records in the NARWC database for this search area."
 } else {
   "There are relevant records in the NARWC database for this search area."
 }
writeLines(Report_narwc)
```
```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: High. Security level: none. Map showing the search area defined by the user (red outline). Map displays information from the North Atlantic Right Whale Consortium (NARWC) Sightings Database, for cetacean species in the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listing. <b>Absence of a species in the map should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area</b> since survey effort is biased towards the Northeast US, and data on species presence from acoustic detections is not included. For more information, please visit: <https://www.narwc.org/sightings-database.html>'}
if (!is.null(outputList)) {
  areaMap+ 
    geom_point(data = narwc_points, aes(x = long, y = lat, color = Legend),
                       size = 2, shape = 20)+ 
    ggplot2::scale_colour_manual(values=whale_col)
}
```

### **Ocean Biodiversity Information System (OBIS) [for cetaceans]**  

#### ***Area-specific OBIS cetacean search results***

```{r obis, include=FALSE, cache=FALSE}
outputList <- main_intersect(obis_cet_sf, studyArea, Bbox = bboxMap)

if (!is.null(outputList)) {
  obis_cet_points <- sfcoords_as_cols(outputList[[2]])
}
```
*
```{r obis result, comment="", prompt=TRUE, echo=FALSE, results='asis'}
Report_obis_cet <-  if (is.null(outputList)) {
  "There are no relevant records of cetaceans in the Ocean Biodiversity Information System (OBIS) for this search area."
} else {
  "There are relevant records of cetaceans in the Ocean Biodiversity Information System (OBIS) for this search area."
}
writeLines(Report_obis_cet)
```

```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: Medium. Security level: none. Map showing the search area defined by the user (red outline). Map displays information from the Ocean Biodiversity Information System (OBIS), for cetacean species contained within the search area and listed by the <i>Species At Risk Act</i> (SARA), assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC), or included in the Wild species listing. <b>The absence of a species in this map should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area.</b> Absence may be related to low or no survey effort. Sightings information is known to underrepresent the presence of cetaceans, particularly deep diving species (e.g., beaked whales) that spend little time at the surface. This map also does not include acoustic detections. Sightings on land are an indicator that the sighting data have not yet been completely error-checked or that animals were sighted from shore.'}
if (!is.null(outputList)) {
  areaMap+ 
    geom_point(data = obis_cet_points, aes(x = long, y = lat, color = Legend),
               size = 2, shape = 20)+
    ggplot2::scale_colour_manual(values=whale_col)
}
```

### **Species Distribution Models (SDM): Priority Areas to Enhance Monitoring of Cetaceans**  

#### ***Area-specific SDM cetacean search results***
```{r sdm, include=FALSE, cache=FALSE}
fin_whale_sf<-stars::st_as_stars(fin_whale)%>%sf::st_as_sf()
harbour_porpoise_sf<-stars::st_as_stars(harbour_porpoise)%>%sf::st_as_sf()
humpback_whale_sf<-stars::st_as_stars(humpback_whale)%>%sf::st_as_sf()
sei_whale_sf<-stars::st_as_stars(sei_whale)%>%sf::st_as_sf()

table_sdm <- sdm_table(fin_whale_sf, harbour_porpoise_sf, humpback_whale_sf, sei_whale_sf, studyArea)
```
```{r}
 knitr::kable(table_sdm, align="cccc", caption="Quality Tier: Low. Security level: none. Results showing if the search area overlap with predicted Priority Areas to Enhance Monitoring of several species of cetaceans (Fin Whale, Harbour Porpoise, Humpback Whale and Sei Whale). TRUE = polygon does overlap with priority area; FALSE = polygon does NOT overlap with priority area.", booktabs = T, escape = F, linesep="") %>% kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: Low. Security level: none. Map shows consolidated Species Distribution Modelling outputs (60-100% relative predicted occurrence rate). Yellow polygons (habitats with high suitability) are to be interpreted as areas where cetacean monitoring efforts may be prioritized, and results can help direct future survey efforts. Due to the many reasons listed in the discussion section in Gomez et al. (2020), these cetacean modelling outputs do not represent a complete and current distribution of cetaceans in the region. They represent priority areas to direct cetacean monitoring efforts. Their use in marine spatial planning processes should be accompanied by complementary approaches such as the process summarized in the section below. The data product summarized in the section below (Blue Whale Important Habitat in the Western North Atlantic) represents an excellent framework in which to properly use the outputs of this figure.'}
plot_cetaceans_4grid(fin_whale_sf, harbour_porpoise_sf, humpback_whale_sf, sei_whale_sf, studyArea, land10m_sf, 200, bounds_sf)
```

### **Blue Whale Important Habitat**  
#### ***Area-specific Blue Whale Important Habitat search results***
*
```{r bw result, echo=FALSE, results='asis'}
# BW <- blue_whale_habitat_overlap(BlueWhale_ImpHab_sf, studyArea)
# writeLines(BW)
outputList <- poly_intersect(BlueWhale_ImpHab_sf, Region, studyArea, Bbox = bboxMap)
Report <- if (is.null(outputList)) {
    "Search area does not overlap with Blue Whale Important Habitat in the Western North Atlantic."
  } else {
    "Search area overlaps with Blue Whale Important Habitat in the Western North Atlantic."
}
writeLines(Report)

areaMapBW <- areaMap+
           geom_sf(data=outputList[[2]],fill="red",col="black")
regionMapBW <- regionMap+
             geom_sf(data=outputList[[3]],fill="red",col="black")
```

```{r bw plots, echo=FALSE, results='asis'}
# BW_wide <- plot_bw_hab(BlueWhale_ImpHab_sf, studyArea, land10m_sf, bounds_sf)
# BW_zoom <- plot_bw_hab_zoom(BlueWhale_ImpHab_sf, studyArea, land50k_sf, 100, bounds_sf)
```

```{r, fig.height=4, fig.width=11, fig.cap='Quality Tier: High. Security level: none. Blue Whale Important Habitat in the Western North Atlantic. Polygons delimit areas in Canadian waters that are important to Blue Whales for foraging and migration. These areas identified in the report by Lesage et al. (2018) are considered important for the survival and recovery of Blue Whales from the western North Atlantic population. Blue Whales most likely need to use several of these important habitats to fulfill their biological needs. As a result, access corridors and habitat they connect need to be considered equally important for the population.'}
# grid.arrange(BW_wide, BW_zoom, bottom = expression(paste("Longitude ",degree,"N",sep="")),
#              left = expression(paste("Latitude",degree,"N",sep="")),
#              nrow = 1,
#              widths = c(4.1/10, 5.9/10))
if (!is.null(outputList)) {
   grid.arrange(regionMapBW, areaMapBW, nrow = 1, widths = c(4.1/10, 5.9/10))
}
```

### **Northern bottlenose whale important habitat in inter-canyon areas on the eastern Scotian Shelf**  
#### ***Area-specific Northern Bottlenose Whale Important Habitat in inter-canyon areas on the eastern Scotian Shelf search results*** 
*
```{r nbnw result, echo=FALSE, results='asis'}
outputList <- poly_intersect(NBNW_ImpHab_sf, Region, studyArea, Bbox = bboxMap)
Report <- if (is.null(outputList)) {
    "Search area does not overlap with Northern Bottlenose Whale Important Habitat in the Western North Atlantic."
  } else {
    "Search area overlaps with Northern Bottlenose Whale Important Habitat in the Western North Atlantic."
}
writeLines(Report)

areaMapNBNW <- areaMap+
           geom_sf(data=outputList[[2]],fill="red",col="black")
regionMapNBNW <- regionMap+
             geom_sf(data=outputList[[3]],fill="red",col="black")



  # NBNW<-intersect_NBNW_overlap(NBNW_ImpHab_sf, studyArea)
  # writeLines(NBNW)
```
```{r nbnw plots, echo=FALSE, results='asis'}
  # NBNW_wide<-plot_NBNW_hab(NBNW_ImpHab_sf, studyArea, land10m_sf, bounds_sf)
  # NBNW_zoom<-plot_NBNW_hab_zoom(NBNW_ImpHab_sf, studyArea, land50k_sf, 100, bounds_sf)
```

```{r, fig.height=8, fig.width=11, fig.cap='Quality Tier: High. Security level: none. Proposed Northern Bottlenose Whales important habitat in inter-canyon areas on the eastern Scotian Shelf. Northern Bottlenose Whales are present year-round in the inter-canyon areas, which function as foraging habitat and movement corridors. Note that the full extent of important habitat for Scotian Shelf Northern Bottlenose Whales remains unknown. Please see additional information in <a href="http://publications.gc.ca/collections/collection_2020/mpo-dfo/fs70-6/Fs70-6-2020-008-eng.pdf">DFO 2020</a>.'}
# grid.arrange(NBNW_wide, NBNW_zoom, bottom = expression(paste("Longitude ",degree,"N",sep="")), left = expression(paste("Latitude ",degree,"N",sep="")), nrow = 1, widths = c(4.1/10, 5.9/10))
if (!is.null(outputList)) {
   grid.arrange(regionMapNBNW, areaMapNBNW, nrow = 1, widths = c(4.1/10, 5.9/10))
}
```