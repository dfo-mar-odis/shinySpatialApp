---
title: "Reproducible Report for internal DFO use only: DRAFT"
subtitle: "{{u_text}}"
author: "Report generated by: {{u_name}} ({{u_email}})"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  bookdown::html_document2:
    number_sections: FALSE
    theme: paper
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
bibliography: '`r here::here("app/data/mybiblio.bib")`'
---

<style>
table {background-color: white !important;color: black !important;}
caption {color: black !important;}
a:link {color: #002080;}
a:visited {color: #008040;}
a:hover {color: #006080;}
</style>

```{r setup-and-libraries, echo=FALSE, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
```

```{r load-data-and-functions, echo=FALSE, include=FALSE, cache=FALSE}
minYear <- 2010

lapply(list.files(here::here("app/R"), pattern = ".[Rr]$", full.names = TRUE), source) # check helpers.R for a list of packages
copy_rdata_files() # make sure data files are up to date. 
load(here::here("app/data/testData.RData"))
#load(here::here("app/data/OpenData.RData"))
#load(here::here("app/data/OpenData_sardist.RData"))
#load(here::here("app/data/SecureData.RData"))

listed_species <- listed_species[!c(listed_species$`COSEWIC status` == "No Status" & listed_species$`SARA status` == "No Status"), ]
row.names(listed_species) <- NULL

```

```{r  Load-Search-Area, echo=FALSE, include=FALSE, cache=FALSE}
region <- st_read(here::here("app/studyAreaTest/geoms_slc_MarBioRegion.geojson"))
studyArea <- region
site <- sf::st_centroid(studyArea)
```

```{r parameters-for-area_map.r, echo=FALSE, include=FALSE, cache=FALSE}
mapDataList <- maps_setup(studyArea, site, region, land50k_sf, land10m_sf, bounds_sf)
list2env(mapDataList, envir = environment())
```

```{r set up summary and gap tables, echo=FALSE, include=FALSE, cache=FALSE}
summarySarTable <- data.frame("Species" = listed_species$`Common Name`, "COSEWIC" = listed_species$`COSEWIC status`, "SARA" = listed_species$`SARA status`)
summaryHabTable <- data.frame("Species" = listed_species$`Common Name`, "COSEWIC" = listed_species$`COSEWIC status`, "SARA" = listed_species$`SARA status`, "Obs" = NA, "range" = NA, "SDM" = NA, "IH" = NA, "CH" = NA)

```

# **REPRODUCIBLE REPORTING**  

#### **Comments provided by user**

{{u_comments}}


## **EXECUTIVE SAR DATABASE SUMMARY**

TO BE CHECKED BEFORE MERGING! 
This section summarizes the SAR coverage of the data sources used in the report. A summary of the data sources containing records of each species with a status under COSEWIC or SARA in the study area is provided.  The caveats and conditions for each individual data source are detailed above in their dedicated sections of the report. An absence of records is not necessarily an absence of the species in the area.  Data sources included below are limited to species point data. A description of the different sources of information for Species at Risk is also available in the infographic: <https://github.com/dfo-mar-odis/shinySpatialApp/blob/master/app/data/misc/SAR-information-type-reproducible-reports.pdf>)


```{r cetacean-setup, echo=FALSE, include=FALSE, cache=FALSE}
whaleCol <- c("Beluga Whale: Endangered (SARA & COSEWIC)" = "cyan3",
               "Blue Whale: Endangered (SARA & COSEWIC)" = "black", 
               "Fin Whale: Special Concern (SARA & COSEWIC)" = "chartreuse4",
               "Harbour Porpoise: Threatened (SARA) Special Concern (COSEWIC)" = "#F5A4E7",
               "Killer Whale: No Status (SARA) & Special Concern (COSEWIC)" = "#00AFBB", 
               "North Atlantic Right Whale: Endangered (SARA & COSEWIC)" = "darkorchid4", 
               "Northern Bottlenose Whale: Endangered (SARA & COSEWIC)" = "#0827EF", 
               "Sei Whale: No Status (SARA) & Endangered (COSEWIC)" = "#EF6408", 
               "Sowerby's Beaked Whale: Special Concern (SARA & COSEWIC)" = "red")
whaleShape <- rep_len(15:20, length(names(whaleCol)))
names(whaleShape) <- names(whaleCol)
whaleSummaryTable <- data.frame("specIndex"= sub("\\:.*", "", names(whaleShape)) ,"Species" = names(whaleShape))
```

```{r fill-summary-sar-table, include=FALSE, cache=FALSE}
# wsdb
wsdbClipped <- master_intersect(wsdb_sf, mapDataList)$studyData
linkedSectionText <- "WSDB"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, wsdbClipped, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# whitehead
whiteheadClipped <- master_intersect(whitehead_sf, mapDataList)$studyData
linkedSectionText <- "Whitehead"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, whiteheadClipped, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# narwc
narwcClipped <- master_intersect(narwc_sf, mapDataList)$studyData
linkedSectionText <- "NARWC"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, narwcClipped, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# obis cetaceans
obisClipped <- master_intersect(obis_cet_sf, mapDataList)$studyData
linkedSectionText <- "OBIS-Cetaceans"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, obisClipped, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# RV
rvClipped <- master_intersect(RVCatch_sf, mapDataList, Year = minYear)$studyData
rvSarTable <- create_table_RV(rvClipped, listed_species, speciesTable = RVGSSPECIES)$sarData
summarySarTable <- add_col_to_sar_summary(summarySarTable, "RV", rvSarTable, "Common Name", "Individuals")

# Marfis/ISDB
outputListI <- master_intersect(isdb_sf, mapDataList, Year = minYear)$studyData
outputListM <- master_intersect(marfis_sf, mapDataList, Year = minYear)$studyData
isdbSarTable <- create_table_ISDB(outputListI, listed_species, speciesTable = ISSPECIESCODES)$sarData
summarySarTable <- add_col_to_sar_summary(summarySarTable, "ISDB", isdbSarTable, "Common Name", "Records")

marfisSarTable <- create_table_MARFIS(outputListM, listed_species, speciesTable = MARFISSPECIESCODES)$sarData
summarySarTable <- add_col_to_sar_summary(summarySarTable, "MARFIS", marfisSarTable, "Common Name", "Records")

# OBIS
obisClipped <- master_intersect(obis_fish_sf, mapDataList, Year = minYear)$studyData
obisTable <- create_table_OBIS(obisClipped)
summarySarTable <- add_col_to_sar_summary(summarySarTable, "OBIS", obisTable, "Common Name", "Common Name")

# OCEARCH
ocearchOutputList <- master_intersect(ocearch_sf, mapDataList)$studyData
if (!is.null(ocearchOutputList)) {
   ocearchSummaryRow <- data.frame("CommonName" = c("White Shark"))
} else {
  ocearchSummaryRow <- NULL
}
summarySarTable <- add_col_to_sar_summary(summarySarTable, "OCEARCH",
                                          ocearchSummaryRow, "CommonName", "CommonName")


```

```{r fill-summary-hab-table, include=FALSE, cache=FALSE}
# crithab, sardist
outputListSardist <- master_intersect(sardist_sf, mapDataList)$studyData
outputListCrithab <- master_intersect(ClippedCritHab_sf, mapDataList)$studyData
outputListLB <- master_intersect(leatherback_sf, mapDataList)$studyData
critHabCheck <- !is.null(outputListCrithab$studyData) | !is.null(outputListLB$studyData)
distTable <- table_dist(outputListSardist$studyData)
summaryHabTable <- add_to_hab_summary(summaryHabTable, "range", "SAR Distribution",  distTable, "Common Name", "Common Name")

if (critHabCheck) {
  critTable <- table_crit(outputListCrithab$studyData, outputListLB$studyData)  
  summaryHabTable <- add_to_hab_summary(summaryHabTable, "CH", "SAR Critical Habitat", critTable, "Common Name", "Common Name")
}

# sdm
clippedFin <- master_intersect(fin_whale_sf, mapDataList, getRegion = TRUE)
clippedHp <- master_intersect(harbour_porpoise_sf, mapDataList, getRegion = TRUE)
clippedHump <- master_intersect(humpback_whale_sf , mapDataList, getRegion = TRUE)
clippedSei <- master_intersect(sei_whale_sf, mapDataList, getRegion = TRUE)
tableSDM <- data.frame("Fin Whale" = !is.null(clippedFin$studyData),
                        "Harbour Porpoise" = !is.null(clippedHp$studyData),
                        "Humpback Whale" = !is.null(clippedHump$studyData),
                        "Sei Whale" = !is.null(clippedSei$studyData),
                        check.names = FALSE)
summarySDMTable <- data.frame("Species" = names(tableSDM), "present" = transpose(tableSDM)$V1)
summaryHabTable <- add_to_hab_summary(summaryHabTable, "SDM", "SDM", summarySDMTable, "Species", "present")

# bw
attribute <- "Activity"
clipped <- master_intersect(BlueWhale_ImpHab_sf, mapDataList, getRegion=TRUE)
if(!is.null(clipped$studyData)){
  summaryBWTable <- data.frame("Species" = "Blue Whale")
  summaryHabTable <- add_to_hab_summary(summaryHabTable, "IH", "BW Habitat", summaryBWTable, "Species", "Species")
}

#nbw
clipped <- master_intersect(NBNW_ImpHab_sf, mapDataList, getRegion=TRUE)
if(!is.null(clipped$studyData)){
  summaryNBWTable <- data.frame("Species" = "Northern Bottlenose Whale")
  summaryHabTable <- add_to_hab_summary(summaryHabTable, "IH", "NBW Habitat", summaryNBWTable, "Species", "Species")
}

```


```{r sar-obs-summary-table}
absentCode <- "&nbsp;-&nbsp;"
presentCode <- "&#x2714;"
summarySarTable[is.na(summarySarTable)] <- absentCode
formatedSarTable <- mutate_all(summarySarTable, ~ cell_spec(., color = ifelse(. == presentCode, "white", ""), background = ifelse(. == presentCode, "green", ""), escape = FALSE))

```

```{r sar-hab-summary-table}
  summaryHabTable[is.na(summaryHabTable)] <- "&nbsp;-&nbsp;"

  # add column for observations from sar table
  obsColumn <- apply(summarySarTable, 1, function(r) any(r %in% c(presentCode)))
  summaryHabTable$Obs <- ifelse(obsColumn, presentCode, absentCode)
  
  summaryHabTable <- mutate_all(summaryHabTable, ~ cell_spec(., color = ifelse(. == presentCode, "white", ""),
                  background = ifelse(. == presentCode, "green", ""), escape = FALSE))

  names(summaryHabTable) <- c("Species", "COSEWIC", "SARA", "Observations", "SAR Range", "SDM", "Important Habitat", "Critical Habitat")

  
```

```{r output-hab-table}
knitr::kable(summaryHabTable, align="l", caption = "INITIAL TEXT FINALIZE BEFORE USING OFFICIALLY. Summary of Observation, Range, Modeling and Habitat results in the study area for each SAR. A summary of the observation data sources is presented in the subsequent table.  ", booktabs = T, escape = F, linesep = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r output-sar-table}
knitr::kable(formatedSarTable, align="l", caption = "INITIAL TEXT FINALIZE BEFORE USING OFFICIALLY. Summary of data sources containing records for each SAR in the study area used in this report. ", booktabs = T, escape = F, linesep = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")

```


# **CONTRIBUTORS**
```{r read-contributors, echo=FALSE, cache=FALSE, include = FALSE}
people <- read.csv(here::here("app/data/misc/contributors.csv"))
people <- people$list
sort(people)
```
List of contributors (listed in alphabetical order): `r knitr::combine_words(people)`.

For more information about this report, please contact Tana.Worcester@dfo-mpo.gc.ca

# **REFERENCES**    
