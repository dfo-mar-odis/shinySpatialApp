---
title: "Reproducible Report for internal DFO use only: DRAFT"
subtitle: "{{u_text}}"
author: "Report generated by: {{u_name}} ({{u_email}})"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  bookdown::html_document2:
    number_sections: FALSE
    theme: paper
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
bibliography: '`r here::here("app/data/mybiblio.bib")`'
---

<style>
table {background-color: white !important;color: black !important;}
caption {color: black !important;}
a:link {color: #002080;}
a:visited {color: #008040;}
a:hover {color: #006080;}
</style>

```{r setup-and-libraries, echo=FALSE, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.align="left")
```

```{r load-data-and-functions, echo=FALSE, include=FALSE, cache=FALSE}
minYear <- 2010

lapply(list.files(here::here("app/R"), pattern = ".[Rr]$", full.names = TRUE), source) # check helpers.R for a list of packages
copy_rdata_files() # make sure data files are up to date. 
filesLoaded <- load_rdata(c("CommonData", "sardist_rr", "crithab_rr", "leatherback_rr", 
                            "rv_rr", "isdb_rr", "marfis_rr", "obisFish_rr", "ocearch_rr", 
                            "wsdb_rr", "whitehead_rr", "obisCet_rr", "blueWhaleHab_rr", 
                            "nbw_rr", "narwc_rr", "rockweed_rr", "ebsa_rr",
                            "conservationSites_rr", "finWhale_rr", "harbourPorpoise_rr",
                            "humpbackWhale_rr", "seiWhale_rr"), "MAR", env = environment())

listed_species <- listed_species[!c(listed_species$`COSEWIC status` == "No Status" & listed_species$`SARA status` == "No Status"), ]
row.names(listed_species) <- NULL

```

```{r  Load-Search-Area, echo=FALSE, include=FALSE, cache=FALSE}
studyArea <- region_sf
site <- sf::st_centroid(studyArea)
```

```{r parameters-for-area_map.r, echo=FALSE, include=FALSE, cache=FALSE}
mapDataList <- maps_setup(studyArea, site, region_sf, land50k_sf, land10m_sf, bounds_sf)
list2env(mapDataList, envir = environment())
```

```{r set up summary and gap tables, echo=FALSE, include=FALSE, cache=FALSE}
summarySarTable <- data.frame("Species" = listed_species$`Common Name`, "COSEWIC" = listed_species$`COSEWIC status`, "SARA" = listed_species$`SARA status`)
summaryHabTable <- data.frame("Species" = listed_species$`Common Name`, "COSEWIC" = listed_species$`COSEWIC status`, "SARA" = listed_species$`SARA status`, "Obs" = NA, "range" = NA, "SDM" = NA, "IH" = NA, "CH" = NA)

```

# **REPRODUCIBLE REPORTING**  

#### **Comments provided by user**

{{u_comments}}


## **REGIONAL SYNTHESIS: Species listed by SARA, and/or assessed by COSEWIC**

This section provides an overall synthesis of regional data and data products of species contained within the search area that are listed by the Species At Risk Act (SARA), and/or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC). This summary must be used in coordination with all data summaries and products presented throughout the report, including the descriptions, caveats, disclaimers, sources of uncertainty, references to the literature, and contacts who can provide further interpretation. The emphasis of this report is on available observations of species presence (primarily since 2010) and not on absences, quantities (e.g., species abundance or biomass), frequency, or catch information. The absence of a species in this report should be interpreted as an absence of observation or reporting of the species in the search area, not necessarily as a true absence of the species. Outputs are not suitable for real-time, dynamic spatial planning. Because coastal areas of the Scotian Shelf bioregion are generally not adequately sampled to characterize fine-scale ecological characteristics (i.e., species, habitat composition and variability within a sub-regional focal area), the distribution of (some) species, when the focal area is near to the coast, should be used as a first-order estimate limited by the spatial-temporal resolution of available data.


```{r cetacean-setup, echo=FALSE, include=FALSE, cache=FALSE}
whaleCol <- c("Beluga Whale: Endangered (SARA & COSEWIC)" = "cyan3",
               "Blue Whale: Endangered (SARA & COSEWIC)" = "black", 
               "Fin Whale: Special Concern (SARA & COSEWIC)" = "chartreuse4",
               "Harbour Porpoise: Threatened (SARA) Special Concern (COSEWIC)" = "#F5A4E7",
               "Killer Whale: No Status (SARA) & Special Concern (COSEWIC)" = "#00AFBB", 
               "North Atlantic Right Whale: Endangered (SARA & COSEWIC)" = "darkorchid4", 
               "Northern Bottlenose Whale: Endangered (SARA & COSEWIC)" = "#0827EF", 
               "Sei Whale: No Status (SARA) & Endangered (COSEWIC)" = "#EF6408", 
               "Sowerby's Beaked Whale: Special Concern (SARA & COSEWIC)" = "red")
whaleShape <- rep_len(15:20, length(names(whaleCol)))
names(whaleShape) <- names(whaleCol)
whaleSummaryTable <- data.frame("specIndex"= sub("\\:.*", "", names(whaleShape)) ,"Species" = names(whaleShape))
```

```{r fill-summary-sar-table, include=FALSE, cache=FALSE}
# wsdb
linkedSectionText <- "WSDB"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, wsdb_rr$data_sf, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# whitehead
linkedSectionText <- "Whitehead"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, whitehead_rr$data_sf, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# narwc
linkedSectionText <- "NARWC"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, narwc_rr$data_sf, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# obis cetaceans
linkedSectionText <- "OBIS-Cetaceans"
whaleSummaryTable <- add_col_to_whale_summary(whaleSummaryTable, linkedSectionText, obisCet_rr$data_sf, "Legend")
summarySarTable <- add_col_to_sar_summary(summarySarTable, linkedSectionText, whaleSummaryTable, "specIndex", linkedSectionText)

# RV
rvSarTable <- create_table_RV(rv_rr$data_sf, listed_species)$sarData
summarySarTable <- add_col_to_sar_summary(summarySarTable, "RV", rvSarTable, "Common Name", "Individuals")

# Marfis/ISDB
isdbSarTable <- create_table_ISDB(isdb_rr$data_sf, listed_species, speciesTable = ISSPECIESCODES)$sarData
summarySarTable <- add_col_to_sar_summary(summarySarTable, "ISDB", isdbSarTable, "Common Name", "Records")

marfisSarTable <- create_table_MARFIS(marfis_rr$data_sf, listed_species, speciesTable = MARFISSPECIESCODES)$sarData
summarySarTable <- add_col_to_sar_summary(summarySarTable, "MARFIS", marfisSarTable, "Common Name", "Records")

# OBIS
obisTable <- create_table_OBIS(obisFish_rr$data_sf)
summarySarTable <- add_col_to_sar_summary(summarySarTable, "OBIS", obisTable, "Common Name", "Common Name")

# OCEARCH
if (!is.null(ocearch_rr$data_sf)) {
   ocearchSummaryRow <- data.frame("CommonName" = c("White Shark"))
} else {
  ocearchSummaryRow <- NULL
}
summarySarTable <- add_col_to_sar_summary(summarySarTable, "OCEARCH",
                                          ocearchSummaryRow, "CommonName", "CommonName")


```

```{r fill-summary-hab-table, include=FALSE, cache=FALSE}
# crithab, sardist
critHabCheck <- !is.null(crithab_rr$data_sf) | !is.null(leatherback_rr$data_sf)
distTable <- table_dist(sardist_rr$data_sf, "EN")
summaryHabTable <- add_to_hab_summary(summaryHabTable, "range", "SAR Distribution",  distTable, "Common Name", "Common Name")

if (critHabCheck) {
  critTable <- table_crit(crithab_rr$data_sf, leatherback_rr$data_sf, "EN")  
  summaryHabTable <- add_to_hab_summary(summaryHabTable, "CH", "SAR Critical Habitat", critTable, "Common Name", "Common Name")
}

# sdm
tableSDM <- data.frame("Fin Whale" = !is.null(finWhale_rr$data_sf),
                        "Harbour Porpoise" = !is.null(harbourPorpoise_rr$data_sf),
                        "Humpback Whale" = !is.null(humpbackWhale_rr$data_sf),
                        "Sei Whale" = !is.null(seiWhale_rr$data_sf),
                        check.names = FALSE)
summarySDMTable <- data.frame("Species" = names(tableSDM), "present" = transpose(tableSDM)$V1)
summaryHabTable <- add_to_hab_summary(summaryHabTable, "SDM", "SDM", summarySDMTable, "Species", "present")

# bw
attribute <- "Activity"
if(!is.null(blueWhaleHab_rr$data_sf)){
  summaryBWTable <- data.frame("Species" = "Blue Whale")
  summaryHabTable <- add_to_hab_summary(summaryHabTable, "IH", "BW Habitat", summaryBWTable, "Species", "Species")
}

#nbw
if(!is.null(nbw_rr$data_sf)){
  summaryNBWTable <- data.frame("Species" = "Northern Bottlenose Whale")
  summaryHabTable <- add_to_hab_summary(summaryHabTable, "IH", "NBW Habitat", summaryNBWTable, "Species", "Species")
}

```


```{r sar-obs-summary-table}
absentCode <- "&nbsp;-&nbsp;"
presentCode <- "&#x2714;"
summarySarTable[is.na(summarySarTable)] <- absentCode
formatedSarTable <- mutate_all(summarySarTable, ~ cell_spec(., color = ifelse(. == presentCode, "white", ""), background = ifelse(. == presentCode, "green", ""), escape = FALSE))

```

```{r sar-hab-summary-table}
  summaryHabTable[is.na(summaryHabTable)] <- "&nbsp;-&nbsp;"

  # add column for observations from sar table
  obsColumn <- apply(summarySarTable, 1, function(r) any(r %in% c(presentCode)))
  summaryHabTable$Obs <- ifelse(obsColumn, presentCode, absentCode)
  
  summaryHabTable <- mutate_all(summaryHabTable, ~ cell_spec(., color = ifelse(. == presentCode, "white", ""),
                  background = ifelse(. == presentCode, "green", ""), escape = FALSE))

  names(summaryHabTable) <- c("Species", "COSEWIC", "SARA", "Observations", "SAR Range", "SDM", "Important Habitat", "Critical Habitat")

  
```

```{r output-hab-table}
knitr::kable(summaryHabTable, align="l", caption = "Regional synthesis of data and data products of species contained within the search area that are listed by the Species At Risk Act (SARA), and/or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC). Data points (observations) are summarized in more detail in the subsequent table. A description of the different sources of information for Species at Risk is available in the infographic: <https://github.com/dfo-mar-odis/shinySpatialApp/blob/master/app/data/misc/SAR-information-type-reproducible-reports.pdf>). The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area. Outputs are not suitable for real-time, dynamic spatial planning.", booktabs = T, escape = F, linesep = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")
```

```{r output-sar-table}
knitr::kable(formatedSarTable, align="l", caption = "Summary of regional data points (observations) of species contained within the search area that are listed by the Species At Risk Act (SARA), and/or assessed by the Committee on the Status of Endangered Wildlife in Canada (COSEWIC). Presence of a species in at least one of these data sources is reported as a presence in the data points (observations) in the table above. The absence of a species in this table should be interpreted as an absence of reporting, not necessarily as an absence of the species in the area. Outputs are not suitable for real-time, dynamic spatial planning.", booktabs = T, escape = F, linesep = "") %>%
  kable_styling(bootstrap_options = "striped", full_width = T, position = "left")

```


# **CONTRIBUTORS**
```{r read-contributors, echo=FALSE, cache=FALSE, include = FALSE}
people <- read.csv(here::here("app/data/misc/contributors.csv"))
people <- people$list
sort(people)
```
List of contributors (listed in alphabetical order): `r knitr::combine_words(people)`.

For more information about this report, please contact Tana.Worcester@dfo-mpo.gc.ca

# **REFERENCES**    
